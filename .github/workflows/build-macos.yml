name: Build macOS (Universal)

# =============================================================================
# Required GitHub Secrets (Settings > Secrets and variables > Actions):
#
#   APPLE_CERTIFICATE_P12      - Base64-encoded Developer ID Application .p12
#                                Export from Keychain Access, then:
#                                  base64 -i DeveloperIDApplication.p12 | pbcopy
#
#   APPLE_CERTIFICATE_PASSWORD - Password set when exporting the .p12
#
#   APP_STORE_CONNECT_KEY      - Base64-encoded App Store Connect API .p8 key
#                                  base64 -i AuthKey_XXXXXX.p8 | pbcopy
#
#   APP_STORE_CONNECT_KEY_ID   - Key ID from App Store Connect API Keys page
#
#   APP_STORE_CONNECT_ISSUER_ID - Issuer ID from App Store Connect API Keys page
#
#   SCCACHE_BUCKET             - S3 bucket name for sccache (e.g. "librewolf-sccache")
#   AWS_ACCESS_KEY_ID          - AWS credentials for sccache S3 bucket
#   AWS_SECRET_ACCESS_KEY      - AWS credentials for sccache S3 bucket
#
# Optional:
#   SCCACHE_REGION             - S3 region (defaults to us-east-1)
# =============================================================================

on:
  workflow_dispatch:
    inputs:
      version_channel:
        description: "Firefox version channel"
        required: true
        default: "stable"
        type: choice
        options:
          - stable
          - rc
          - beta
          - latest
      skip_notarization:
        description: "Skip notarization (faster, for testing)"
        required: false
        default: false
        type: boolean

  push:
    branches:
      - main

concurrency:
  group: build-macos-${{ github.ref }}
  cancel-in-progress: true

env:
  SCCACHE_GHA_ENABLED: "false"

jobs:
  # ===========================================================================
  # Job 1: Prepare source tarball on cheap Linux runner
  # ===========================================================================
  prepare-source:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.VERSION }}
      release: ${{ steps.version.outputs.RELEASE }}
      source_dir: ${{ steps.version.outputs.SOURCE_DIR }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get -y install python3 pigz gnupg wget unzip

      - name: Detect Firefox version
        if: inputs.version_channel && inputs.version_channel != 'stable'
        id: detect
        run: |
          chmod +x ./scripts/detect-firefox-version.sh
          ./scripts/detect-firefox-version.sh --channel "${{ inputs.version_channel }}" > /tmp/ff-version.env
          cat /tmp/ff-version.env
          source /tmp/ff-version.env
          echo "$FF_VERSION" > version

      - name: Set version outputs
        id: version
        run: |
          echo "VERSION=$(cat version)" >> "$GITHUB_OUTPUT"
          echo "RELEASE=$(cat release)" >> "$GITHUB_OUTPUT"
          echo "SOURCE_DIR=librewolf-$(cat version)-$(cat release)" >> "$GITHUB_OUTPUT"

      - name: Cache source tarball
        id: cache-source
        uses: actions/cache@v4
        with:
          path: librewolf-*.source.tar.gz
          key: librewolf-source-${{ steps.version.outputs.VERSION }}-${{ steps.version.outputs.RELEASE }}

      - name: Build source tarball
        if: steps.cache-source.outputs.cache-hit != 'true'
        run: make all

  # ===========================================================================
  # Job 2: Build arm64 (Apple Silicon) on macos-14
  # ===========================================================================
  build-arm64:
    needs: prepare-source
    runs-on: macos-26
    permissions:
      contents: read
      id-token: write
    env:
      SOURCE_DIR: ${{ needs.prepare-source.outputs.source_dir }}
      LW_VERSION: ${{ needs.prepare-source.outputs.version }}
      LW_RELEASE: ${{ needs.prepare-source.outputs.release }}
      SCCACHE_BUCKET: ${{ secrets.SCCACHE_BUCKET }}
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      SCCACHE_REGION: ${{ secrets.SCCACHE_REGION || 'us-east-1' }}
      SCCACHE_CACHE_SIZE: "20G"
    steps:
      - name: Checkout (for scripts/assets)
        uses: actions/checkout@v4

      - name: Free disk space
        run: |
          sudo rm -rf /Library/Developer/CoreSimulator/Volumes/* || true
          sudo rm -rf ~/Library/Developer/CoreSimulator || true
          df -h /

      - name: Install sccache
        run: |
          brew install sccache
          sccache --version
          echo "RUSTC_WRAPPER=sccache" >> "$GITHUB_ENV"

      - name: Cache bootstrap toolchains
        uses: actions/cache@v4
        with:
          path: ~/.mozbuild
          key: mozbuild-arm64-${{ needs.prepare-source.outputs.version }}
          restore-keys: |
            mozbuild-arm64-

      - name: Restore source tarball from cache
        uses: actions/cache/restore@v4
        with:
          path: librewolf-*.source.tar.gz
          key: librewolf-source-${{ needs.prepare-source.outputs.version }}-${{ needs.prepare-source.outputs.release }}
          fail-on-cache-miss: true

      - name: Extract source
        run: |
          tar xf librewolf-*.source.tar.gz
          ls -la "$SOURCE_DIR/"

      - name: Configure mozconfig for arm64
        run: |
          cp assets/mozconfig.macos "$SOURCE_DIR/mozconfig"
          echo 'ac_add_options --target=aarch64-apple-darwin' >> "$SOURCE_DIR/mozconfig"
          echo 'ac_add_options --with-ccache=sccache' >> "$SOURCE_DIR/mozconfig"
          echo "--- mozconfig ---"
          cat "$SOURCE_DIR/mozconfig"

      - name: Bootstrap
        run: |
          cd "$SOURCE_DIR"
          # The bootstrap may fail on unpack-sdk.py (403 from taskcluster)
          # but this is non-fatal — the macOS runner already has Xcode SDK.
          ./mach --no-interactive bootstrap --application-choice=browser || true
          # Verify essential toolchains were downloaded
          test -d "$HOME/.mozbuild/clang" || { echo "ERROR: clang not bootstrapped"; exit 1; }

      - name: Build
        run: |
          cd "$SOURCE_DIR"
          ./mach build

      - name: Print sccache stats
        if: always()
        run: sccache --show-stats

      - name: Package
        run: |
          cd "$SOURCE_DIR"
          ./mach package

      - name: Extract .app from .dmg
        run: |
          DMG=$(find "$SOURCE_DIR/obj-"* -name "*.dmg" -path "*/dist/*" | head -1)
          echo "Found DMG: $DMG"
          hdiutil attach "$DMG" -mountpoint /tmp/lw-mount -nobrowse
          mkdir -p arm64-app
          cp -a /tmp/lw-mount/LibreWolf.app arm64-app/
          hdiutil detach /tmp/lw-mount
          tar czf librewolf-arm64-app.tar.gz -C arm64-app LibreWolf.app

      - name: Upload arm64 .app
        uses: actions/upload-artifact@v4
        with:
          name: librewolf-arm64-app
          path: librewolf-arm64-app.tar.gz
          retention-days: 1

  # ===========================================================================
  # Job 3: Build x86_64 (Intel) — cross-compiled on macos-14 (ARM)
  # Note: macos-13 (Intel) runners are deprecated by GitHub.
  # ===========================================================================
  build-x86_64:
    needs: prepare-source
    runs-on: macos-26
    permissions:
      contents: read
      id-token: write
    env:
      SOURCE_DIR: ${{ needs.prepare-source.outputs.source_dir }}
      LW_VERSION: ${{ needs.prepare-source.outputs.version }}
      LW_RELEASE: ${{ needs.prepare-source.outputs.release }}
      SCCACHE_BUCKET: ${{ secrets.SCCACHE_BUCKET }}
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      SCCACHE_REGION: ${{ secrets.SCCACHE_REGION || 'us-east-1' }}
      SCCACHE_CACHE_SIZE: "20G"
    steps:
      - name: Checkout (for scripts/assets)
        uses: actions/checkout@v4

      - name: Free disk space
        run: |
          sudo rm -rf /Library/Developer/CoreSimulator/Volumes/* || true
          sudo rm -rf ~/Library/Developer/CoreSimulator || true
          df -h /

      - name: Install sccache
        run: |
          brew install sccache
          sccache --version
          echo "RUSTC_WRAPPER=sccache" >> "$GITHUB_ENV"

      - name: Cache bootstrap toolchains
        uses: actions/cache@v4
        with:
          path: ~/.mozbuild
          key: mozbuild-x86_64-${{ needs.prepare-source.outputs.version }}
          restore-keys: |
            mozbuild-x86_64-

      - name: Restore source tarball from cache
        uses: actions/cache/restore@v4
        with:
          path: librewolf-*.source.tar.gz
          key: librewolf-source-${{ needs.prepare-source.outputs.version }}-${{ needs.prepare-source.outputs.release }}
          fail-on-cache-miss: true

      - name: Extract source
        run: |
          tar xf librewolf-*.source.tar.gz
          ls -la "$SOURCE_DIR/"

      - name: Install x86_64 Rust target for cross-compilation
        run: |
          rustup target add x86_64-apple-darwin

      - name: Configure mozconfig for x86_64
        run: |
          cp assets/mozconfig.macos "$SOURCE_DIR/mozconfig"
          echo 'ac_add_options --target=x86_64-apple-darwin' >> "$SOURCE_DIR/mozconfig"
          echo 'ac_add_options --with-ccache=sccache' >> "$SOURCE_DIR/mozconfig"
          echo "--- mozconfig ---"
          cat "$SOURCE_DIR/mozconfig"

      - name: Bootstrap
        run: |
          cd "$SOURCE_DIR"
          # The bootstrap may fail on unpack-sdk.py (403 from taskcluster)
          # but this is non-fatal — the macOS runner already has Xcode SDK.
          ./mach --no-interactive bootstrap --application-choice=browser || true
          # Verify essential toolchains were downloaded
          test -d "$HOME/.mozbuild/clang" || { echo "ERROR: clang not bootstrapped"; exit 1; }

      - name: Build
        run: |
          cd "$SOURCE_DIR"
          ./mach build

      - name: Print sccache stats
        if: always()
        run: sccache --show-stats

      - name: Package
        run: |
          cd "$SOURCE_DIR"
          ./mach package

      - name: Extract .app from .dmg
        run: |
          DMG=$(find "$SOURCE_DIR/obj-"* -name "*.dmg" -path "*/dist/*" | head -1)
          echo "Found DMG: $DMG"
          hdiutil attach "$DMG" -mountpoint /tmp/lw-mount -nobrowse
          mkdir -p x86_64-app
          cp -a /tmp/lw-mount/LibreWolf.app x86_64-app/
          hdiutil detach /tmp/lw-mount
          tar czf librewolf-x86_64-app.tar.gz -C x86_64-app LibreWolf.app

      - name: Upload x86_64 .app
        uses: actions/upload-artifact@v4
        with:
          name: librewolf-x86_64-app
          path: librewolf-x86_64-app.tar.gz
          retention-days: 1

  # ===========================================================================
  # Job 4: Merge into universal, sign, create DMG, notarize
  # ===========================================================================
  universal-sign-notarize:
    needs: [prepare-source, build-arm64, build-x86_64]
    runs-on: macos-26
    permissions:
      contents: write
      id-token: write
    env:
      LW_VERSION: ${{ needs.prepare-source.outputs.version }}
      LW_RELEASE: ${{ needs.prepare-source.outputs.release }}
    steps:
      - name: Checkout (for scripts)
        uses: actions/checkout@v4

      - name: Download arm64 .app
        uses: actions/download-artifact@v4
        with:
          name: librewolf-arm64-app

      - name: Download x86_64 .app
        uses: actions/download-artifact@v4
        with:
          name: librewolf-x86_64-app

      - name: Extract both .app bundles
        run: |
          mkdir -p arm64-app x86_64-app
          tar xzf librewolf-arm64-app.tar.gz -C arm64-app
          tar xzf librewolf-x86_64-app.tar.gz -C x86_64-app
          echo "arm64:"
          file arm64-app/LibreWolf.app/Contents/MacOS/librewolf
          echo "x86_64:"
          file x86_64-app/LibreWolf.app/Contents/MacOS/librewolf

      - name: Create universal binary
        run: |
          chmod +x scripts/macos-create-universal.sh
          ./scripts/macos-create-universal.sh \
            arm64-app/LibreWolf.app \
            x86_64-app/LibreWolf.app \
            LibreWolf.app

      - name: Import signing certificate
        env:
          APPLE_CERTIFICATE_P12: ${{ secrets.APPLE_CERTIFICATE_P12 }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
        run: |
          # Create a temporary keychain
          KEYCHAIN_PATH="$RUNNER_TEMP/signing.keychain-db"
          KEYCHAIN_PASSWORD="$(openssl rand -base64 32)"

          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          # Import certificate
          echo "$APPLE_CERTIFICATE_P12" | base64 --decode > "$RUNNER_TEMP/cert.p12"
          security import "$RUNNER_TEMP/cert.p12" \
            -P "$APPLE_CERTIFICATE_PASSWORD" \
            -A \
            -t cert \
            -f pkcs12 \
            -k "$KEYCHAIN_PATH"
          rm -f "$RUNNER_TEMP/cert.p12"

          # Allow codesign to access the keychain
          security set-key-partition-list -S apple-tool:,apple:,codesign: \
            -s -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          # Add to search list
          security list-keychains -d user -s "$KEYCHAIN_PATH" $(security list-keychains -d user | tr -d '"')

          # Find the signing identity
          IDENTITY=$(security find-identity -v -p codesigning "$KEYCHAIN_PATH" | grep "Developer ID Application" | head -1 | awk -F'"' '{print $2}')
          echo "Found identity: $IDENTITY"
          echo "SIGNING_IDENTITY=$IDENTITY" >> "$GITHUB_ENV"
          echo "KEYCHAIN_PATH=$KEYCHAIN_PATH" >> "$GITHUB_ENV"
          echo "KEYCHAIN_PASSWORD=$KEYCHAIN_PASSWORD" >> "$GITHUB_ENV"

      - name: Sign app bundle
        run: |
          chmod +x scripts/macos-sign.sh
          ./scripts/macos-sign.sh LibreWolf.app "$SIGNING_IDENTITY" assets/entitlements.plist

      - name: Create DMG
        run: |
          DMG_NAME="librewolf-${LW_VERSION}-${LW_RELEASE}-macos-universal.dmg"
          DMG_TEMP="$RUNNER_TEMP/dmg-staging"

          mkdir -p "$DMG_TEMP"
          cp -a LibreWolf.app "$DMG_TEMP/"
          ln -s /Applications "$DMG_TEMP/Applications"

          hdiutil create \
            -volname "LibreWolf" \
            -srcfolder "$DMG_TEMP" \
            -ov \
            -format UDZO \
            "$DMG_NAME"

          # Sign the DMG itself
          codesign --force --timestamp --sign "$SIGNING_IDENTITY" "$DMG_NAME"

          echo "DMG_NAME=$DMG_NAME" >> "$GITHUB_ENV"
          ls -lh "$DMG_NAME"

      - name: Notarize DMG
        if: ${{ !inputs.skip_notarization }}
        env:
          APP_STORE_CONNECT_KEY: ${{ secrets.APP_STORE_CONNECT_KEY }}
          APP_STORE_CONNECT_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
          APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
        run: |
          # Write the API key to a file for notarytool
          API_KEY_PATH="$RUNNER_TEMP/AuthKey_${APP_STORE_CONNECT_KEY_ID}.p8"
          echo "$APP_STORE_CONNECT_KEY" | base64 --decode > "$API_KEY_PATH"

          echo "Submitting $DMG_NAME for notarization..."
          xcrun notarytool submit "$DMG_NAME" \
            --key "$API_KEY_PATH" \
            --key-id "$APP_STORE_CONNECT_KEY_ID" \
            --issuer "$APP_STORE_CONNECT_ISSUER_ID" \
            --wait \
            --timeout 30m

          echo "Stapling notarization ticket..."
          xcrun stapler staple "$DMG_NAME"

          echo "Verifying notarization..."
          spctl --assess --type open --context context:primary-signature -v "$DMG_NAME"

          rm -f "$API_KEY_PATH"

      - name: Generate checksums
        run: |
          shasum -a 256 "$DMG_NAME" > "${DMG_NAME}.sha256sum"
          shasum -a 512 "$DMG_NAME" > "${DMG_NAME}.sha512sum"
          cat "${DMG_NAME}.sha256sum"

      - name: Upload DMG
        uses: actions/upload-artifact@v4
        with:
          name: librewolf-macos-universal
          path: |
            librewolf-*-macos-universal.dmg
            librewolf-*-macos-universal.dmg.sha256sum
            librewolf-*-macos-universal.dmg.sha512sum
          retention-days: 14

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="v${LW_VERSION}-${LW_RELEASE}"
          TITLE="LibreWolf ${LW_VERSION}-${LW_RELEASE} (macOS Universal)"
          SHA256=$(cat "${DMG_NAME}.sha256sum" | awk '{print $1}')

          # Extract base Firefox version (e.g. 147.0.4 from 147.0.4-1)
          FF_VERSION="${LW_VERSION}"

          # Fetch upstream LibreWolf release notes
          UPSTREAM_NOTES=$(curl -sf "https://codeberg.org/api/v1/repos/librewolf/source/releases/tags/${LW_VERSION}-${LW_RELEASE}" | jq -r '.body // empty') || true

          # Fetch Firefox release notes page and extract key changes
          FF_NOTES_URL="https://www.mozilla.org/en-US/firefox/${FF_VERSION}/releasenotes/"

          cat > /tmp/release-notes.md <<'HEADER'
          ## Install

          ```bash
          brew tap instantcocoa/tap
          brew install --cask librewolf-signed
          ```

          Or download the DMG below.

          HEADER

          # Add upstream notes if available and non-trivial
          if [[ -n "$UPSTREAM_NOTES" ]]; then
            cat >> /tmp/release-notes.md <<UPSTREAM
          ## Upstream Release Notes

          ${UPSTREAM_NOTES}

          UPSTREAM
          fi

          cat >> /tmp/release-notes.md <<FOOTER
          ## Firefox ${FF_VERSION}

          This build is based on Firefox ${FF_VERSION}. See the [Firefox ${FF_VERSION} release notes](${FF_NOTES_URL}) for details on security fixes and changes.

          ## Build Details

          **Universal binary** (arm64 + x86_64) — works on both Apple Silicon and Intel Macs.
          Signed with Developer ID and notarized by Apple.

          | | |
          |---|---|
          | **LibreWolf version** | ${LW_VERSION}-${LW_RELEASE} |
          | **Firefox base** | ${FF_VERSION} |
          | **Architecture** | Universal (arm64 + x86_64) |
          | **Source** | [codeberg.org/librewolf/source](https://codeberg.org/librewolf/source/releases/tag/${LW_VERSION}-${LW_RELEASE}) |

          ### Checksums (SHA-256)
          \`\`\`
          ${SHA256}  ${DMG_NAME}
          \`\`\`
          FOOTER

          # Create the release (or update if tag already exists)
          gh release create "$TAG" \
            --title "$TITLE" \
            --notes-file /tmp/release-notes.md \
            --latest \
            "$DMG_NAME" \
            "${DMG_NAME}.sha256sum" \
            "${DMG_NAME}.sha512sum" \
          || gh release upload "$TAG" \
            "$DMG_NAME" \
            "${DMG_NAME}.sha256sum" \
            "${DMG_NAME}.sha512sum" \
            --clobber

      - name: Update Homebrew cask
        if: success()
        env:
          GH_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
        run: |
          VERSION="${LW_VERSION}-${LW_RELEASE}"
          SHA256=$(cat "${DMG_NAME}.sha256sum" | awk '{print $1}')

          # Trigger the update-cask workflow in the homebrew-tap repo
          gh api repos/instantcocoa/homebrew-tap/dispatches \
            -f event_type=update-cask \
            -f "client_payload[version]=$VERSION" \
            -f "client_payload[sha256]=$SHA256"

          echo "Dispatched homebrew cask update: version=$VERSION sha256=$SHA256"

      - name: Cleanup keychain
        if: always()
        run: |
          if [[ -n "${KEYCHAIN_PATH:-}" ]]; then
            security delete-keychain "$KEYCHAIN_PATH" || true
          fi
